"use strict";(()=>{var u=class r{constructor(t){this._enemy=t}static{this.EVENTNAME="enemy.death"}get enemy(){return this._enemy}get x(){return this._enemy.position.x}get y(){return this._enemy.position.y}get eventName(){return r.EVENTNAME}};var l=class r{static{this.EVENTNAME="game.over"}constructor(){this.endTime=Date.now()}get getEndTime(){return this.endTime}get eventName(){return r.EVENTNAME}};var d=class r{constructor(t){this._gridSquares=t}static{this.EVENTNAME="game.update"}get gridSquares(){return this._gridSquares}get eventName(){return r.EVENTNAME}};var z=class{constructor(){this.subscribe=(t,i)=>{this.events[t]=this.events[t]||[],this.events[t].push(i)};this.unsubscribe=(t,i)=>{this.events[t]&&(this.events[t]=this.events[t].filter(e=>e!==i))};this.publish=t=>{this.events[t.eventName]&&this.events[t.eventName].forEach(i=>i(t))};if(this.instance)throw new Error("New instance cannot be created!");this._events={},this.instance=this}get events(){return this._events}},Y=Object.freeze(new z),a=Y;var f=class r{static{this.EVENTNAME="round.skip"}get eventName(){return r.EVENTNAME}};var X=r=>Math.floor(Math.random()*r);var _=class{constructor(t,i,e){this.grid=t;this.controller=i;this.characterFactory=e;this.enemies=[];this.changes=[];this.initialize=()=>{this.player=this.characterFactory.createPlayer(),this.spawnPlayer(),this.afterRoundActions()};this.spawnPlayer=()=>{let t=this.grid.getGridSquare(this.player.position);t.notNull()&&t.setCharacter(this.player),t.notNull()&&this.changes.push(t)};this.movePlayer=t=>{let i=this.player.position;if(t&&i.x<=0||!t&&i.x>=9)return;let e=i.clone();t?e.substractX():e.addX(),this.player.position=e;let o=this.grid.getGridSquare(i),n=this.grid.getGridSquare(e);o.removeCharacter(),n.setCharacter(this.player),this.changes.push(o,n),this.afterRoundActions()};this.shoot=()=>{let t=this.player.position.x,i=this.enemies.filter(e=>e.position.x===t)?.reduce((e,o)=>(e=e===null?o:e,o.position.y>e.position.y?o:e),null);i&&(i.reduceHealth(1),i.isDead()&&this.removeEnemy(i)),this.afterRoundActions()};this.removeEnemy=t=>{let i=this.grid.getGridSquare(t.position);i.removeCharacter(),this.enemies=this.enemies.filter(e=>!e.position.equals(t.position)),this.changes.push(i),a.publish(new u(t))};this.spawnEnemy=()=>{let t=this.grid.getEmptySpawn(),i=this.characterFactory.createRandomEnemy();t.setCharacter(i),this.changes.push(t),i.setPosition(t.position),this.enemies.push(i)};this.moveEnemies=()=>{this.enemies.forEach(t=>{if(!t.position)return;let i=t.possiblePositions;if(t.movement.y>0&&this.grid.isOutOfBoundsY(i[0])){a.publish(new l);return}let e=this.grid.getGridSquare(t.position);e.removeCharacter();let o=i.filter(m=>this.grid.isValidPosition(m)&&this.grid.isEmpty(m));if(o.length===0){e.setCharacter(t);return}this.changes.push(e);let n=o[X(o.length)];t.setPosition(n);let c=this.grid.getGridSquare(n);c&&c.setCharacter(t),c&&this.changes.push(c)})};this.spawnBoss=()=>{let t=this.grid.getEmptySpawn(),i=this.characterFactory.createKing();t.setCharacter(i),this.changes.push(t),i.setPosition(t.position),this.enemies.push(i)};this.afterRoundActions=()=>{this.moveEnemies(),this.enemies.length<3&&this.spawnEnemy(),a.publish(new d(this.changes)),this.changes=[]};this.end=()=>{this.enemies=[]};a.subscribe(f.EVENTNAME,this.afterRoundActions),this.controller.move=this.movePlayer,this.controller.shoot=this.shoot,this.controller.skip=this.afterRoundActions}};var x=class{constructor(t,i,e){this._canvasX=t;this._canvasY=i;this._icon=e;this.isEmpty=()=>this.icon===null}get icon(){return this._icon}get iconPositionX(){return this._canvasX}get iconPositionY(){return this._canvasY}};var y=class{constructor(t){this.gridOptions=t;this.map=(t,i,e)=>{let o=t*this.gridOptions.gridSquareWidth+this.gridPaddingX,n=i*this.gridOptions.gridSquareHeight+this.gridPaddingY;return new x(o,n,e)};this.gridPaddingX=(this.gridOptions.gridSquareWidth-this.gridOptions.iconWidth)/2,this.gridPaddingY=(this.gridOptions.gridSquareHeight-this.gridOptions.iconHeight)/2}};var b=class{get position(){return this._position}get icon(){return this._icon}};var s=class{constructor(t,i){this._x=t;this._y=i}get x(){return this._x}get y(){return this._y}};var h=class r{constructor(t,i){this._x=t;this._y=i;this.addX=()=>this._x+=1;this.substractX=()=>this._x-=1;this.equals=t=>this._x===t.x&&this._y===t.y;this.notNull=()=>this._x!==-1||this._y!==-1;this.clone=()=>new r(this._x,this._y)}static{this.createNullPosition=()=>new this(-1,-1)}get x(){return this._x}get y(){return this._y}};var v=class extends b{constructor(i,e){super();this._movementIndex=0;this.setPosition=i=>{this._position=i,this._movementIndex=this._movementIndex==this._movement[0].length-1?0:this._movementIndex+1};this.reduceHealth=i=>{this._health-=i};this.isDead=()=>this._health<=0;this._position=i,this._health=e,this._movement=[[new s(0,0),new s(0,1)]]}get position(){return this._position}get movement(){return this._movement[0][this._movementIndex]}get possiblePositions(){return this._movement.map(i=>new h(this._position.x+i[this._movementIndex].x,this._position.y+i[this._movementIndex].y))}get icon(){return this._icon}get health(){return this._health}};var P=class r{constructor(t){this._enemy=t}static{this.EVENTNAME="enemy.hit"}get icon(){return this._enemy.icon}get x(){return this._enemy.position.x}get y(){return this._enemy.position.y}get eventName(){return r.EVENTNAME}};var p=class{constructor(t,i,e){this._width=t;this._height=i;let o=new Image;o.src=e,this._image=o}get image(){return this._image}get width(){return this._width}get height(){return this._height}};var w=class extends v{constructor(i,e){super(i,e);this.reduceHealth=i=>{this._health-=i,a.publish(new P(this)),this.isDead()&&a.publish(new l)};this._icon=new p(30,35,"../../images/king.svg"),this._movement=[[new s(0,0),new s(0,0),new s(-1,1)],[new s(0,0),new s(0,0),new s(0,1)],[new s(0,0),new s(0,0),new s(1,1)]]}};var C=class extends v{constructor(t,i){super(t,i),this._icon=new p(30,35,"../../images/knight.png"),this._movement=[[new s(0,0),new s(1,2)],[new s(0,0),new s(-1,2)]]}};var G=class extends v{constructor(t,i){super(t,i),this._icon=new p(33,33,"../../images/pawn.png"),this._movement=[[new s(0,0),new s(0,1)]]}};var I=class extends b{constructor(){super();this.updatePosition=i=>{let e=this._position.x;i=="ArrowLeft"?e-=this._position.x>0?1:0:e+=this._position.x<9?1:0,this._position=new h(e,this._position.y)};this._icon=new p(30,30,"../../images/player.svg"),this._position=new h(0,15)}set position(i){this._position=i}get position(){return this._position}get icon(){return this._icon}};var q=class{constructor(){this.createRandomEnemy=()=>{let t=Math.floor(Math.random()*3);return t%2===0&&t!=0?this.createKnight():this.createPawn()};this.createPawn=()=>new G(new h(1,1),1);this.createKnight=()=>new C(new h(1,1),1);this.createKing=()=>new w(new h(1,1),10);this.createPlayer=()=>new I}};var A=class{constructor(t){this.controls=t;this.handleAction=t=>{switch(t.key){case this.controls.left:this._move(!0);break;case this.controls.right:this._move(!1);break;case this.controls.shoot:this._shoot();break;case this.controls.skip:this._skip();break}};document.addEventListener("keyup",this.handleAction)}set move(t){this._move=t}set shoot(t){this._shoot=t}set skip(t){this._skip=t}};var N=class{constructor(t,i){this.options=t;this.effectFactory=i;this.animations=[];this.running=!1;this.addAnimation=(t,i)=>{let e=this.effectFactory.getEffect(i,t);e&&this.animations.push(e),this.requestAnimation()};this.requestAnimation=()=>{if(!this.hasAnimations()){this.running=!1;return}this.running=!0,this.context.clearRect(0,0,1e3,1e3),this.animations.forEach(t=>{t.update(),this.drawParticles(t)}),this.removeAnimations(),requestAnimationFrame(this.requestAnimation)};this.hasAnimations=()=>this.animations.length!=0;this.removeAnimations=()=>{this.animations=this.animations.filter(t=>!t.isDead())};this.drawParticles=t=>{t.particles.forEach(i=>{this.context.beginPath(),this.context.arc(i.x,i.y,i.radius,0,Math.PI*2,!1),this.context.fillStyle=`rgba(255,100, 0, ${i.alpha})`,this.context.fill()})};let e=document.createElement("canvas");e.id="effect",e.style.position="absolute",e.style.top="100px",e.style.left="10px";let o=e.getContext("2d");o&&(this.context=o),document.getElementById(this.options.elementId)?.append(e);let n=this.options.height*this.options.gridSquareHeight,c=this.options.width*this.options.gridSquareWidth+2*10;this.context.canvas.width=c,this.context.canvas.height=n+100}};var E=class{constructor(t){this._position=t;this.notNull=()=>this.position.notNull();this.isEmpty=()=>this._character===null;this.setCharacter=t=>this._character=t;this.removeCharacter=()=>this._character=null;this._character=null}get position(){return this._position}get x(){return this._position.x}get y(){return this._position.y}get icon(){return this._character?.icon??null}static{this.create=()=>new this(h.createNullPosition())}};var S=class{constructor(t){this.gridOptions=t;this.grid=[];this.buildGrid=()=>{for(let t=0;t<=this.gridOptions.height;t++)for(let i=0;i<this.gridOptions.width;i++){let e=new h(i,t);this.grid.push(new E(e))}};this.isEmpty=t=>this.getGridSquare(t).isEmpty();this.isValidPosition=t=>t.x>=0&&t.x<this.gridOptions.width&&t.y>=0&&t.y<=this.gridOptions.height;this.isOutOfBoundsX=t=>t.x>=this.gridOptions.width;this.isOutOfBoundsY=t=>t.y>=this.gridOptions.height;this.getGridSquare=t=>{let i=t.y*this.gridOptions.width+t.x;return this.grid[i]??E.create()};this.getEmptySpawn=()=>{let t=this.grid.slice(0,this.gridOptions.width-1).filter(i=>i.isEmpty());return t[X(t.length-1)]};this.grid=[],this.buildGrid()}};var T=class{constructor(t,i,e){this.grid=t;this.effect=i;this.PositionMapper=e;this.initialize=()=>{this.handleEvents(),this.grid.initialize()};this.handleEvents=()=>{a.subscribe(d.EVENTNAME,this.updateGrid),a.subscribe(u.EVENTNAME,this.addEffect)};this.addEffect=t=>{let i=this.PositionMapper.map(t.x,t.y,null);this.effect.addAnimation(i,"explosion")};this.updateGrid=t=>{t.gridSquares.filter(i=>i.isEmpty()).map(i=>this.PositionMapper.map(i.x,i.y,i.icon)).forEach(i=>this.grid.clearPosition(i)),t.gridSquares.filter(i=>!i.isEmpty()).map(i=>this.PositionMapper.map(i.x,i.y,i.icon)).forEach(i=>this.grid.renderIcon(i))}}};var M=class{constructor(t){this.options=t;this.initialize=()=>{this.draw()};this.clearCanvas=()=>{this.context.clearRect(0,0,1e3,1e3)};this.clearPosition=t=>{this.context.clearRect(t.iconPositionX-1,t.iconPositionY-1,this.options.gridSquareWidth-5,this.options.gridSquareHeight-2)};this.renderIcon=t=>{let i=t.icon;i&&this.context.drawImage(i.image,t.iconPositionX,t.iconPositionY,i.width,i.height)};this.draw=()=>{document.getElementById(this.options.elementId)?.append(this.canvas);let t=0,i=this.options.width*this.options.gridSquareWidth,e=this.options.height*this.options.gridSquareHeight;this.drawHorizontal(t,i,e),this.drawVertital(t,i,e),this.context.strokeStyle="black",this.context?.stroke()};this.drawHorizontal=(t,i,e)=>{for(let o=0;o<=i;o+=this.options.gridSquareWidth){let n=.5+o+t,c=t,m=.5+o+t,g=e+t;this.context?.moveTo(n,c),this.context?.lineTo(m,g)}};this.drawVertital=(t,i,e)=>{for(let o=0;o<=e;o+=this.options.gridSquareHeight){let n=t,c=.5+o+t,m=i+t,g=.5+o+t;this.context?.moveTo(n,c),this.context?.lineTo(m,g)}};this.canvasPadding=10,this.canvas=document.createElement("canvas"),this.canvas.id=t.gameCanvas,this.canvas.style.position="absolute",this.canvas.style.top="100px",this.canvas.style.left="10px";let i=this.canvas.getContext("2d");i&&(this.context=i),this.context.canvas.width=this.options.width*this.options.gridSquareWidth+2*this.canvasPadding,this.context.canvas.height=this.options.height*this.options.gridSquareHeight+100}};var O=class r{constructor(){this._currentTime=0;this._currentTime=Date.now()}static{this.EVENTNAME="game.action"}get currentTime(){return this._currentTime}get eventName(){return r.EVENTNAME}};var F=class{constructor(){this.kills=0;this.actions=0;this._boss=!1;this.initialize=()=>{this.roundLength=500,this.roundCurrentLength=0,this.gameActive=!1,this.start(),this.requestId=0};this.action=t=>{this.actions+=1,this.roundCurrentLength=0};this.start=()=>{this.gameActive=!0,this.requestId||(this.requestId=requestAnimationFrame(this.loop)),this.startTime=Date.now()};this.end=()=>{this.gameActive=!1,cancelAnimationFrame(this.requestId),this.requestId=0,this.endTime=Date.now();let t=(this.endTime-this.startTime)/this.actions;alert(`Game ended. score: ${t}`)};this.resetCounter=()=>{this.roundCurrentLength=0};this.addKills=()=>{this.kills+=1};this.getKills=()=>this.kills;this.isActive=()=>this.gameActive;this.loop=()=>{this.gameActive&&(this.roundCurrentLength>=this.roundLength&&(this.roundCurrentLength=0,a.publish(new f)),this.roundCurrentLength+=5,requestAnimationFrame(this.loop))};a.subscribe(d.EVENTNAME,this.resetCounter),a.subscribe(u.EVENTNAME,this.addKills),a.subscribe(O.EVENTNAME,this.action)}set boss(t){this._boss=t}get boss(){return this._boss}};var L={controls:{left:"ArrowLeft",right:"ArrowRight",shoot:"ArrowUp",skip:"ArrowDown"},difficulty:[{round_length:1e4,enemy_health:1,boss_health:5}],gridOptions:{width:10,height:15,gridSquareWidth:40,gridSquareHeight:40,iconHeight:35,iconWidth:30,elementId:"game-container",gameCanvas:"game",effectCanvas:"effect"}};var k=class{constructor(t,i,e,o,n,c,m,g){this._x=t;this._y=i;this.dx=e;this.dy=o;this.up=n;this.right=c;this._ttl=m;this.update=()=>{this._x+=this.right==!0?+-this.dx:this.dx,this._y+=this.up==!0?+-this.dy:this.dy,this._ttl-=10};this.isDead=()=>this.ttl<=0;this._alpha=1,this._radius=g||1.5}get x(){return this._x}get y(){return this._y}get radius(){return this._radius}get alpha(){return this._alpha}get ttl(){return this._ttl}};var V=class{constructor(t){this._position=t;this.particleCount=20;this.ttl=300;this.isDead=()=>this.activeParticles.length===0;this.update=()=>this.activeParticles.length>0?(this.activeParticles.forEach(t=>{t.update(),t.isDead()&&(this.activeParticles=this.activeParticles.filter(i=>i!==t))}),this.activeParticles):[];this.activeParticles=[];let i=this._position.iconPositionX+15,e=this._position.iconPositionY+15;for(let o=0;o<=this.particleCount;o++){let n=(Math.random()-.5)*2,c=(Math.random()-.5)*2,m=Math.floor(Math.random()*10)%2==0,g=Math.floor(Math.random()*10)%2==0;this.activeParticles.push(new k(i,e,n,c,m,g,this.ttl))}}get particles(){return this.activeParticles}};var R=class{constructor(){this.getEffect=(t,i)=>{switch(t){case"explosion":return this.createExplosion(i)}};this.createExplosion=t=>new V(t)}};var H=class{constructor(){let t=L;this._controller=new A(t.controls);let i=new R,e=new M(t.gridOptions),o=new N(t.gridOptions,i),n=new y(t.gridOptions);this._renderer=new T(e,o,n),this._characterFactory=new q,this._state=new F,this._board=new _(new S(t.gridOptions),this._controller,this._characterFactory)}get characterFactory(){return this.characterFactory}get board(){return this._board}get renderer(){return this._renderer}get state(){return this._state}get game(){return this._game}};var D=class{constructor(){this.initialize=()=>{this.state.initialize(),this.renderer.initialize(),this.board.initialize()};this.endGame=()=>{this.state.end(),this.board.end()};this.container=new H,this.state=this.container.state,this.renderer=this.container.renderer,this.board=this.container.board,a.subscribe(l.EVENTNAME,this.endGame)}};new D().initialize();})();
