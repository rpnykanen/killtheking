"use strict";(()=>{var d=class{constructor(t){this._enemy=t}static{this.EVENTNAME="enemy.death"}get enemy(){return this._enemy}get x(){return this._enemy.position.x}get y(){return this._enemy.position.y}get eventName(){return"enemy.death"}};var v=class{constructor(t){this._win=t;this.endTime=Date.now()}static{this.EVENTNAME="game.over"}get getEndTime(){return this.endTime}get eventName(){return"game.over"}get win(){return this._win}};var p=class{constructor(t){this._gridSquares=t}static{this.EVENTNAME="game.update"}get gridSquares(){return this._gridSquares}get eventName(){return"game.update"}};var L=r=>Math.floor(Math.random()*r);var E=class{constructor(t){this._enemy=t}static{this.EVENTNAME="enemy.hit"}get icon(){return this._enemy.icon}get x(){return this._enemy.position.x}get y(){return this._enemy.position.y}get eventName(){return"enemy.hit"}};var y=class{constructor(t,e,i){this.grid=t;this.characterFactory=e;this.eventManager=i;this.enemies=[];this.changes=[];this.boss=null;this.deadEnemyCount=0;this.maxEnemies=3;this.initialize=()=>{this.player=this.characterFactory.createPlayer(),this.spawnPlayer(),this.afterRoundActions()};this.movePlayer=t=>{let e=this.player.position;if(t&&e.x<=0||!t&&e.x>=this.grid.getMaxX)return;let i=e.clone();t?i.substractX():i.addX(),this.player.position=i;let n=this.grid.getGridSquare(e),s=this.grid.getGridSquare(i);n.removeCharacter(),s.setCharacter(this.player),this.changes.push(n,s),this.afterRoundActions()};this.shoot=()=>{let t=this.enemies.filter(e=>e.position.x===this.player.position.x)?.reduce((e,i)=>(e=e===null?i:e,i.position.y>e.position.y?i:e),null);t&&(t.reduceHealth(1),this.eventManager.publish(new E(t)),this.afterRoundActions())};this.afterRoundActions=()=>{let t=this.checkWincondition();this.removeDeadEnemies();let e=this.checkLosecondition();if(t||e){this.eventManager.publish(new v(t));return}this.moveEnemies(),this.handleEndgameState(),this.spawnEnemy(),this.eventManager.publish(new p(this.changes)),this.changes=[]};this.checkWincondition=()=>!!this.enemies.find(e=>e.isBoss&&e.isDead);this.checkLosecondition=()=>!!this.enemies.find(e=>{let i=e.possiblePositions[0];return e.movement.y>0&&this.grid.isOutOfBoundsY(i)});this.removeDeadEnemies=()=>{this.enemies=this.enemies.map(t=>(t.isDead&&(this.removeEnemy(t),this.eventManager.publish(new d(t)),this.deadEnemyCount+=1),t)).filter(t=>!t.isDead)};this.removeEnemy=t=>{let e=this.grid.getGridSquare(t.position);e.removeCharacter(),this.changes.push(e)};this.moveEnemies=()=>{this.enemies.forEach(t=>{let i=t.possiblePositions.filter(h=>this.grid.isValidPosition(h)&&this.grid.isEmpty(h));if(i.length===0){t.setPosition(t.position);return}this.removeEnemy(t);let n=i[L(i.length)];t.setPosition(n);let s=this.grid.getGridSquare(n);s.setCharacter(t),this.changes.push(s)})};this.spawnPlayer=()=>{let t=this.grid.getGridSquare(this.player.position);t.setCharacter(this.player),this.changes.push(t)};this.spawnEnemy=()=>{if(this.isBoardFull())return;let t=this.grid.getEmptySpawn(),e=this.characterFactory.createRandomEnemy();t.setCharacter(e),this.changes.push(t),e.setPosition(t.position,!1),this.enemies.push(e),this.changes.push(t)};this.handleEndgameState=()=>{this.deadEnemyCount!==20||this.boss||(this.boss=this.characterFactory.createKing(),this.enemies.push(this.boss))}}isBoardFull(){return this.enemies.length>=this.maxEnemies}};var g=class{get position(){return this._position}get icon(){return this._icon}};var o=class{constructor(t,e){this._x=t;this._y=e}get x(){return this._x}get y(){return this._y}};var a=class r{constructor(t,e){this._x=t;this._y=e;this.addX=()=>this._x+=1;this.substractX=()=>this._x-=1;this.equals=t=>this._x===t.x&&this._y===t.y;this.notNull=()=>this._x!==-1||this._y!==-1;this.clone=()=>new r(this._x,this._y)}static{this.createNullPosition=()=>new this(-1,-1)}get x(){return this._x}get y(){return this._y}};var m=class extends g{constructor(e,i){super();this._movementIndex=0;this.setPosition=(e,i=!0)=>{this._position=e,i&&this.updateMovementIndex()};this.reduceHealth=e=>{this._health-=e};this._position=e,this._health=i,this._movements=[[new o(0,0),new o(0,1)]]}updateMovementIndex(){this._movementIndex=this._movementIndex==this._movements[0].length-1?0:this._movementIndex+1}get isDead(){return this._health<=0}get position(){return this._position}get movement(){return this._movements[0][this._movementIndex]}get possiblePositions(){return this._movements.map(e=>new a(this._position.x+e[this._movementIndex].x,this._position.y+e[this._movementIndex].y))}get icon(){return this._icon}get health(){return this._health}get isBoss(){return!1}};var c=class{constructor(t,e,i){this._width=t;this._height=e;let n=new Image;n.src=i,this._image=n}get image(){return this._image}get width(){return this._width}get height(){return this._height}};var x=class extends m{constructor(e,i){super(e,i);this.reduceHealth=e=>{this._health-=e};this._icon=new c(30,35,"../../images/king.svg"),this._movements=[[new o(0,0),new o(0,0),new o(-1,1)],[new o(0,0),new o(0,0),new o(0,1)],[new o(0,0),new o(0,0),new o(1,1)]]}get isBoss(){return!0}};var w=class extends m{constructor(t,e){super(t,e),this._icon=new c(30,35,"../../images/knight.png"),this._movements=[[new o(0,0),new o(1,2)],[new o(0,0),new o(-1,2)]]}};var P=class extends m{constructor(t,e){super(t,e),this._icon=new c(33,33,"../../images/pawn.png"),this._movements=[[new o(0,0),new o(0,1)]]}};var C=class extends g{constructor(){super();this.updatePosition=e=>{let i=this._position.x;e=="ArrowLeft"?i-=this._position.x>0?1:0:i+=this._position.x<9?1:0,this._position=new a(i,this._position.y)};this._icon=new c(30,30,"../../images/player.svg"),this._position=new a(0,15)}set position(e){this._position=e}get position(){return this._position}get icon(){return this._icon}};var b=class{constructor(){this.createRandomEnemy=()=>{let t=Math.floor(Math.random()*3);return t%2===0&&t!=0?this.createKnight():this.createPawn()};this.createPawn=()=>new P(new a(1,1),1);this.createKnight=()=>new w(new a(1,1),1);this.createKing=()=>new x(new a(1,1),10);this.createPlayer=()=>new C}};var M=class{};var I=class extends M{constructor(e){super();this.controls=e;this.setupPlayerControls=(e,i,n,s)=>{this._move=e,this._shoot=i,this._skip=n,this._reset=s};this.handleAction=e=>{switch(e.code){case this.controls.left:this._move(!0);break;case this.controls.right:this._move(!1);break;case this.controls.shoot:this._shoot();break;case this.controls.skip:this._skip();break;case this.controls.reset:this._reset();break}};document.addEventListener("keyup",this.handleAction)}};var q=class{constructor(t,e){this.options=t;this.effectFactory=e;this.animations=[];this.running=!1;this.addAnimation=(t,e)=>{let i=this.effectFactory.getEffect(e,t);i&&this.animations.push(i),this.requestAnimation()};this.requestAnimation=()=>{if(!this.hasAnimations()){this.running=!1;return}this.running=!0,this.context.clearRect(0,0,1e3,1e3),this.animations.forEach(t=>{t.update(),this.drawParticles(t)}),this.removeAnimations(),requestAnimationFrame(this.requestAnimation)};this.hasAnimations=()=>this.animations.length!=0;this.removeAnimations=()=>{this.animations=this.animations.filter(t=>!t.isDead())};this.drawParticles=t=>{t.particles.forEach(e=>{this.context.beginPath(),this.context.arc(e.x,e.y,e.radius,0,Math.PI*2,!1),this.context.fillStyle=`rgba(255,100, 0, ${e.alpha})`,this.context.fill()})};let i=document.createElement("canvas");i.id=t.effectCanvas,i.style.position="absolute",i.style.top="100px",i.style.left="10px";let n=i.getContext("2d");n&&(this.context=n),document.getElementById(this.options.elementId)?.append(i);let s=this.options.height*this.options.gridSquareHeight,h=this.options.width*this.options.gridSquareWidth+2*10;this.context.canvas.width=h,this.context.canvas.height=s+100}};var _=class{constructor(t){this._position=t;this.notNull=()=>this.position.notNull();this.isEmpty=()=>this._character===null;this.setCharacter=t=>this._character=t;this.removeCharacter=()=>this._character=null;this._character=null}get position(){return this._position}get x(){return this._position.x}get y(){return this._position.y}get icon(){return this._character?.icon??null}static{this.create=()=>new this(a.createNullPosition())}};var G=class{constructor(t){this.gridOptions=t;this.grid=[];this.buildGrid=()=>{for(let t=0;t<=this.gridOptions.height;t++)for(let e=0;e<this.gridOptions.width;e++){let i=new a(e,t);this.grid.push(new _(i))}};this.getGridSquare=t=>{let e=t.y*this.gridOptions.width+t.x;return this.grid[e]??_.create()};this.isValidPosition=t=>t.x>=0&&t.x<this.gridOptions.width&&t.y>=0&&t.y<=this.gridOptions.height;this.isEmpty=t=>this.getGridSquare(t).isEmpty();this.isOutOfBoundsX=t=>t.x>=this.gridOptions.width;this.isOutOfBoundsY=t=>t.y>=this.gridOptions.height;this.getEmptySpawn=()=>{let t=this.grid.slice(0,this.getMaxX).filter(e=>e.isEmpty());return t[L(t.length-1)]};this.buildGrid()}get getMaxX(){return this.gridOptions.width-1}};var S=class{constructor(t,e,i,n,s){this._canvasX=t;this._canvasY=e;this._centerX=i;this._centerY=n;this._icon=s;this.isEmpty=()=>this.icon===null}get icon(){return this._icon}get iconPositionX(){return this._canvasX}get iconPositionY(){return this._canvasY}get centerX(){return this._centerX}get centerY(){return this._centerY}};var A=class{constructor(t){this.gridOptions=t;this.map=(t,e,i)=>{let n=t*this.gridOptions.gridSquareWidth+this.gridPaddingX,s=e*this.gridOptions.gridSquareHeight+this.gridPaddingY,h=t*this.gridOptions.gridSquareWidth+this.gridOptions.gridSquareWidth/2,u=e*this.gridOptions.gridSquareHeight+this.gridOptions.gridSquareHeight/2;return new S(n,s,h,u,i)};this.gridPaddingX=(this.gridOptions.gridSquareWidth-this.gridOptions.iconWidth)/2,this.gridPaddingY=(this.gridOptions.gridSquareHeight-this.gridOptions.iconHeight)/2}};var O=class{constructor(t,e,i,n){this.grid=t;this.effect=e;this.positionMapper=i;this.eventManager=n;this.initialize=()=>{this.handleEvents(),this.grid.initialize()};this.handleEvents=()=>{this.eventManager.subscribe(p.EVENTNAME,this.rerenderGrid),this.eventManager.subscribe(d.EVENTNAME,this.addEffect)};this.addEffect=t=>{let e=this.positionMapper.map(t.x,t.y,null);this.effect.addAnimation(e,"explosion")};this.rerenderGrid=t=>{t.gridSquares.filter(e=>e.isEmpty()).map(e=>this.positionMapper.map(e.x,e.y,e.icon)).forEach(e=>this.grid.clearPosition(e)),t.gridSquares.filter(e=>!e.isEmpty()).map(e=>this.positionMapper.map(e.x,e.y,e.icon)).forEach(e=>this.grid.renderIcon(e))};this.end=()=>{}}};var N=class{constructor(t){this.options=t;this.initialize=()=>{this.draw()};this.clearCanvas=()=>{this.context.clearRect(0,0,1e3,1e3)};this.clearPosition=t=>{this.context.clearRect(t.iconPositionX-1,t.iconPositionY-1,this.options.gridSquareWidth-5,this.options.gridSquareHeight-2)};this.renderIcon=t=>{let e=t.icon;e&&this.context.drawImage(e.image,t.iconPositionX,t.iconPositionY,e.width,e.height)};this.draw=()=>{document.getElementById(this.options.elementId)?.append(this.canvas);let t=0,e=this.options.width*this.options.gridSquareWidth,i=this.options.height*this.options.gridSquareHeight;this.drawHorizontal(t,e,i),this.drawVertital(t,e,i),this.context.strokeStyle="black",this.context?.stroke()};this.drawHorizontal=(t,e,i)=>{for(let n=0;n<=e;n+=this.options.gridSquareWidth){let s=.5+n+t,h=t,u=.5+n+t,l=i+t;this.context?.moveTo(s,h),this.context?.lineTo(u,l)}};this.drawVertital=(t,e,i)=>{for(let n=0;n<=i;n+=this.options.gridSquareHeight){let s=t,h=.5+n+t,u=e+t,l=.5+n+t;this.context?.moveTo(s,h),this.context?.lineTo(u,l)}};this.canvasPadding=10,this.canvas=document.createElement("canvas"),this.canvas.id=t.gameCanvas,this.canvas.style.position="absolute",this.canvas.style.top="100px",this.canvas.style.left="10px";let e=this.canvas.getContext("2d");e&&(this.context=e),this.context.canvas.width=this.options.width*this.options.gridSquareWidth+2*this.canvasPadding,this.context.canvas.height=this.options.height*this.options.gridSquareHeight+100}};var f=class{static{this.EVENTNAME="round.skip"}get eventName(){return"round.skip"}};var F=class{constructor(t){this.eventManager=t;this.kills=0;this.actions=0;this._boss=!1;this.initialize=()=>{this.roundLength=1e3,this.roundCurrentLength=0,this.gameActive=!1,this.start(),this.requestId=0};this.action=t=>{this.actions+=1,this.roundCurrentLength=0};this.start=()=>{this.gameActive=!0,this.requestId||(this.requestId=requestAnimationFrame(this.loop)),this.startTime=Date.now()};this.end=t=>{this.gameActive=!1,cancelAnimationFrame(this.requestId),this.requestId=0,this.endTime=Date.now(),confirm(`You ${t?"win":"lose"}!`),location.reload()};this.resetCounter=()=>{this.roundCurrentLength=0};this.addKills=()=>{this.kills+=1};this.getKills=()=>this.kills;this.isActive=()=>this.gameActive;this.loop=()=>{this.gameActive&&(this.roundCurrentLength>=this.roundLength&&(this.roundCurrentLength=0,this.eventManager.publish(new f)),this.roundCurrentLength+=5,requestAnimationFrame(this.loop))};this.eventManager.subscribe(p.EVENTNAME,this.resetCounter)}};var Y={controls:{left:"ArrowLeft",right:"ArrowRight",shoot:"ArrowUp",skip:"ArrowDown",reset:"Space"},difficulty:[{roundLength:1e4,enemyHealth:1,bossHealth:5,enemyAmount:20}],gridOptions:{width:10,height:15,gridSquareWidth:40,gridSquareHeight:40,iconHeight:35,iconWidth:30,elementId:"game-container",gameCanvas:"game",effectCanvas:"effect"},misc:{autoplay:!1}};var T=class{constructor(t,e,i,n,s,h,u,l){this._x=t;this._y=e;this.dx=i;this.dy=n;this.up=s;this.right=h;this._ttl=u;this.update=()=>{this._x+=this.right==!0?+-this.dx:this.dx,this._y+=this.up==!0?+-this.dy:this.dy,this._ttl-=10,this._alpha-=.02};this.isDead=()=>this.ttl<=0;this._alpha=1,this._radius=l||1.5}get x(){return this._x}get y(){return this._y}get radius(){return this._radius}get alpha(){return this._alpha}get ttl(){return this._ttl}};var k=class{constructor(t){this._position=t;this.particleCount=20;this.ttl=300;this.isDead=()=>this.activeParticles.length===0;this.update=()=>this.activeParticles.length>0?(this.activeParticles.forEach(t=>{t.update(),t.isDead()&&(this.activeParticles=this.activeParticles.filter(e=>e!==t))}),this.activeParticles):[];this.activeParticles=[];let e=this._position.centerX,i=this._position.centerY;for(let n=0;n<this.particleCount;n++){let s=(Math.random()-.5)*2,h=(Math.random()-.5)*2,u=Math.floor(Math.random()*10)%2==0,l=Math.floor(Math.random()*10)%2==0;this.activeParticles.push(new T(e,i,s,h,u,l,this.ttl))}}get particles(){return this.activeParticles}};var H=class{constructor(){this.getEffect=(t,e)=>{switch(t){case"explosion":return this.createExplosion(e)}};this.createExplosion=t=>new k(t)}};var X=class{constructor(){this._events={};this.subscribe=(t,e)=>{this.events[t]=this.events[t]||[],this.events[t].push(e)};this.unsubscribe=(t,e)=>{this.events[t.eventName]&&(this.events[t.eventName]=this.events[t.eventName].filter(i=>i!==e))};this.publish=t=>{this.events[t.eventName]&&this.events[t.eventName].forEach(e=>e(t))}}get events(){return this._events}};var R=class{constructor(){let t=Y,e=new H;this._eventManager=new X,this._renderer=new O(new N(t.gridOptions),new q(t.gridOptions,e),new A(t.gridOptions),this._eventManager),this._controller=new I(t.controls),this._characterFactory=new b,this._state=new F(this._eventManager),this._board=new y(new G(t.gridOptions),new b,this._eventManager)}get eventManager(){return this._eventManager}get controller(){return this._controller}get board(){return this._board}get renderer(){return this._renderer}get state(){return this._state}};var D=class{constructor(){this.initialize=()=>{this.state.initialize(),this.renderer.initialize(),this.board.initialize(),this.state.start()};this.endGame=t=>{this.state.end(t.win)};this.restart=()=>{location.reload()};this.container=new R,this.controller=this.container.controller,this.eventManager=this.container.eventManager,this.state=this.container.state,this.renderer=this.container.renderer,this.board=this.container.board,this.controller.setupPlayerControls(this.board.movePlayer,this.board.shoot,this.board.afterRoundActions,this.restart),this.update()}update(){this.eventManager.subscribe(f.EVENTNAME,this.board.afterRoundActions),this.eventManager.subscribe(v.EVENTNAME,this.endGame)}};new D().initialize();})();
